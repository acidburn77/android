From 0fb9ce01dbbd11cd52a349f5294598c933652f09 Mon Sep 17 00:00:00 2001
From: milaq <micha.laqua@gmail.com>
Date: Mon, 6 Jan 2014 16:52:58 +0100
Subject: [PATCH] flo: fix up usb otg for kk

---
 fstab.flo                                                 |  2 +-
 init.flo.rc                                               | 13 +++++++++----
 overlay/frameworks/base/core/res/res/xml/storage_list.xml |  2 +-
 3 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/fstab.flo b/fstab.flo
index 56a76c3..f7eabec 100644
--- a/fstab.flo
+++ b/fstab.flo
@@ -11,4 +11,4 @@
 /dev/block/platform/msm_sdcc.1/by-name/recovery     /recovery       emmc    defaults                                                                     defaults
 /dev/block/platform/msm_sdcc.1/by-name/misc         /misc           emmc    defaults                                                                     defaults
 
-/devices/platform/msm_hsusb_host/usb    /storage/usbdisk0       auto    default     voldmanaged=sda:auto
+/devices/platform/msm_hsusb_host/usb                auto            auto    default     voldmanaged=usbdisk:auto
diff --git a/init.flo.rc b/init.flo.rc
index 5c73971..5e2939e 100644
--- a/init.flo.rc
+++ b/init.flo.rc
@@ -27,20 +27,21 @@ on init
     mkdir /storage/emulated 0555 root root
 
     # USB storage
-    mkdir /storage/usbdisk0 0000 system system
+    mkdir /mnt/media_rw/usbdisk 0700 media_rw media_rw
+    mkdir /storage/usbdisk 0700 root root
 
     export EXTERNAL_STORAGE /storage/emulated/legacy
     export EMULATED_STORAGE_SOURCE /mnt/shell/emulated
     export EMULATED_STORAGE_TARGET /storage/emulated
-    export SECONDARY_STORAGE /storage/usbdisk0
+    export SECONDARY_STORAGE /storage/usbdisk
 
     # Support legacy paths
     symlink /storage/emulated/legacy /sdcard
     symlink /storage/emulated/legacy /mnt/sdcard
     symlink /storage/emulated/legacy /storage/sdcard0
     symlink /mnt/shell/emulated/0 /storage/emulated/legacy
-    symlink /storage/usbdisk0 /usbdisk0
-    symlink /storage/usbdisk0 /mnt/usbdisk0
+    symlink /storage/usbdisk /usbdisk
+    symlink /storage/usbdisk /mnt/usbdisk
 
 on init
     # Set permissions for persist partition
@@ -459,6 +460,10 @@ service charger /charger
 service sdcard /system/bin/sdcard -u 1023 -g 1023 -l /data/media /mnt/shell/emulated
     class late_start
 
+service fuse_usbdisk /system/bin/sdcard -u 1023 -g 1023 -w 1023 -d /mnt/media_rw/usbdisk /storage/usbdisk
+    class late_start
+    disabled
+
 service thermald /system/bin/thermald
     class main
 
diff --git a/overlay/frameworks/base/core/res/res/xml/storage_list.xml b/overlay/frameworks/base/core/res/res/xml/storage_list.xml
index 66d7953..2006d77 100644
--- a/overlay/frameworks/base/core/res/res/xml/storage_list.xml
+++ b/overlay/frameworks/base/core/res/res/xml/storage_list.xml
@@ -27,7 +27,7 @@
         android:primary="true"
         android:mtpReserve="100" />
 
-    <storage android:mountPoint="/storage/usbdisk0"
+    <storage android:mountPoint="/storage/usbdisk"
         android:storageDescription="@string/storage_usb"
         android:primary="false"
         android:removable="true" />
-- 
1.8.3.2

